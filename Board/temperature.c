/**
 * @file temperature.c
 * @brief
 * @author xqyjlj (xqyjlj@126.com)
 * @version 0.0
 * @date 2021-08-04
 * @copyright Copyright © 2020-2021 xqyjlj<xqyjlj@126.com>
 *
 * *********************************************************************************
 * @par ChangeLog:
 * <table>
 * <tr><th>Date       <th>Version <th>Author  <th>Description
 * <tr><td>2021-08-04 <td>0.0     <td>xqyjlj  <td>内容
 * </table>
 * *********************************************************************************
 */
#include "temperature.h"
#include "rtthread.h"
#include "system.h"
#include "gpio.h"
#include "main.h"
#include "eeprom.h"

BMS_Temperature_Struct BMS_Temperature[80] = {0};


/**
 * @brief 江苏易感素智能科技有限公司 100K B=4150K 0~100度，每1度 温度阻值表
 */
uint32_t EKX_NTC_Table_100K_4150[EKX_NTC_TABLE_100K_4150_COUNT] =
{
    349200, 331000, 313900, 297700, 282500, 268100, 254500, 241700, 229600, 218100,
    207300, 197100, 187500, 178300, 169700, 161500, 153800, 146400, 139500, 132900,
    126700, 120700, 115100, 109800, 104800, 100000, 95460,  91140,  87050,  83160,
    79460,  75950,  72600,  69430,  66410,  63530,  60790,  58190,  55710,  53350,
    51100,  46910,  44970,  43110,  41340,  39650,  38040,  36500,  35030,  33630,
    32290,  31010,  29790,  28620,  27500,  26440,  25420,  24440,  23500,  22510,
    21760,  20940,  20150,  19400,  18680,  17990,  17330,  16700,  16090,  15510,
    14950,  14000,  42000,  13900,  13410,  12940,  12480,  12050,  11630,  11230,
    10840,  10470,  10110,  9767,   9438,   9120,   8815,   8522,   8240,   7968,
    7707,   7455,   7213,   6979,   6755,   6539,   6330,   6129,   5935,   5749,
    5569
};

/**
 * @brief 江苏易感素智能科技有限公司 100K B=4150K 0~100度，每1度 温度电压表，对应电压被放大1000 * 100000 = 100000000倍
 */
uint32_t EKX_NTC_Voltage_Table_100K_4150[EKX_NTC_TABLE_100K_4150_COUNT] =
{
    233214604, 230394432, 227518724, 224566256, 221568627, 218500407, 215373766, 212203687, 208980583, 205690035,
    202375529, 199023898, 195652174, 192202659, 188765295, 185277247, 181796690, 178246753, 174739040, 171189352,
    167666520, 164068872, 160529986, 157006673, 153515625, 150000000, 146515911, 143046981, 139615076, 136208779,
    132831829, 129497016, 126187717, 122935726, 119722372, 116547422, 113421233, 110354637, 107334147, 104369090,
    101455989, 95793343,  93060633,  90371043,  87745861,  85177229,  82671689,  80219780,  77827150,  75499514,
    73225489,  71009847,  68857385,  66754782,  64705882,  62733312,  60803700,  58919961,  57085020,  55122031,
    53613666,  51943112,  50312110,  48743719,  47219414,  45741165,  44310918,  42930591,  41579809,  40282227,
    39016964,  36842105,  88732394,  36611062,  35473062,  34372233,  33285917,  32262383,  31255039,  30288591,
    29339589,  28433059,  27545182,  26693815,  25872183,  25073314,  24302716,  23558357,  22838137,  22139893,
    21466571,  20813364,  20183187,  19571131,  18982717,  18412976,  17859494,  17325142,  16807476,  16309374,
    15825669
};

uint8_t NTC_Search_Table(uint32_t* table, uint32_t voltage)
{
    uint8_t s_idx, m_idx, e_idx;
    uint16_t m_val;

    // 检查数据合法性
    if (voltage > table[0] || voltage < table[EKX_NTC_TABLE_100K_4150_COUNT - 1])
    {
        return 0xff;
    }

    s_idx = 0;
    e_idx = EKX_NTC_TABLE_100K_4150_COUNT - 1;

    // 二分法查找
    while (s_idx + 1 < e_idx)
    {
        m_idx = (s_idx + e_idx) >> 1;
        m_val = table[m_idx];
        if (voltage < m_val)
        {
            s_idx = m_idx;
        }
        else if (voltage > m_val)
        {
            e_idx = m_idx;
        }
        else
        {
            return m_idx;
        }
    }

    return s_idx;
}

uint8_t get_temperature(uint32_t* table, uint32_t voltage, BMS_Temperature_Struct* obj)
{
    uint8_t idx;
    uint32_t* pt;

    idx = NTC_Search_Table(table, voltage);
    if (idx == 0xff)
    {
        return 0;
    }
    pt = table + idx;
    obj->temperature = idx;
    obj->temperature_f = (*pt - voltage) * 10 / (*pt - * (pt + 1));
    return 1;
}
